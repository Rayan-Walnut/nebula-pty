<!DOCTYPE html>
<html>
<head>
    <title>Terminal Web</title>
    <link rel="stylesheet" href="/xterm/css/xterm.css" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #000;
        }
        #terminal { 
            flex: 1;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    
    <script src="/xterm/lib/xterm.js"></script>
    <script src="/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#ffffff',
                cursor: '#ffffff'
            },
            fontFamily: 'Consolas, monospace',
            fontSize: 14,
            lineHeight: 1.2,
            convertEol: true,
            scrollback: 1000,
            disableStdin: false
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        let ws = null;
        let currentLine = '';

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}`);

            ws.onopen = () => {
                term.write('\r\nConnecté au terminal...\r\n');
            };

            ws.onclose = () => {
                term.write('\r\nDéconnecté du terminal. Tentative de reconnexion...\r\n');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('Erreur WebSocket:', error);
            };

            ws.onmessage = (event) => {
                term.write(event.data);
            };
        }

        connectWebSocket();

        term.onData(data => {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            // Gestion des touches spéciales
            if (data === '\r') { // Touche Entrée
                ws.send('\r');
                currentLine = '';
            } else if (data === '\u007F') { // Touche Backspace
                if (currentLine.length > 0) {
                    currentLine = currentLine.substring(0, currentLine.length - 1);
                    term.write('\b \b');
                }
            } else {
                currentLine += data;
                ws.send(data);
            }
        });

        function handleResize() {
            fitAddon.fit();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }
        }

        window.addEventListener('resize', handleResize);
        setTimeout(handleResize, 100);
    </script>
</body>
</html>