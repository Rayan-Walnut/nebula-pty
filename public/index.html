<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Web</title>
    <link rel="stylesheet" href="/xterm/css/xterm.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #terminal-container {
            flex: 1;
            padding: 10px;
            background-color: #000;
        }

        #terminal {
            width: 100%;
            height: 100%;
        }

        #status-bar {
            height: 25px;
            background-color: #333;
            color: #fff;
            padding: 4px 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="terminal-container">
        <div id="terminal"></div>
    </div>
    <div id="status-bar">
        <span id="connection-status">Déconnecté</span>
        <span id="reconnect-info"></span>
    </div>

    <script src="/xterm/lib/xterm.js"></script>
    <script>
        const maxReconnectAttempts = 5;
        let reconnectAttempts = 0;
        let ws = null;
        let currentLine = '';
        let terminalId = null;
        let isConnecting = false;
        let commandHistory = [];
        let historyIndex = -1;

        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas,monospace',
            theme: {
                background: '#000000',
                foreground: '#ffffff',
                cursor: '#ffffff'
            },
            convertEol: true,
            cursorStyle: 'bar'
        });

        term.open(document.getElementById('terminal'));

        function updateStatus(status, info = '') {
            document.getElementById('connection-status').textContent = status;
            document.getElementById('reconnect-info').textContent = info;
        }

        function connect() {
            if (isConnecting) return;
            isConnecting = true;

            console.log('Connexion WebSocket...');
            ws = new WebSocket(`ws://${window.location.host}`);

            ws.onopen = () => {
                console.log('WebSocket connecté');
                isConnecting = false;
                reconnectAttempts = 0;
                updateStatus('Connecté');
            };

            ws.onclose = () => {
                console.log('WebSocket fermé');
                isConnecting = false;
                updateStatus('Déconnecté');

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    updateStatus('Déconnecté', `Reconnexion ${reconnectAttempts}/${maxReconnectAttempts}`);
                    setTimeout(connect, 2000);
                }
            };

            ws.onerror = (error) => {
                console.error('Erreur WebSocket:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    if (message.type === 'terminal-id') {
                        terminalId = message.id;
                    } else if (message.type === 'output') {
                        term.write(message.data);
                    }
                } catch (error) {
                    console.error('Erreur message:', error);
                }
            };
        }
        let outputHistory = [];

        function handleSpecialCommands(command) {
            switch (command.trim().toLowerCase()) {
                case 'clear':
                case 'cls':
                    // Séquence ANSI pour effacer l'écran et repositionner le curseur
                    term.write('\x1b[2J\x1b[H');
                    term.write('> ');
                    return true;

                default:
                    return false;
            }
        }

        term.onData(e => {
            if (!ws || ws.readyState !== WebSocket.OPEN || !terminalId) return;

            switch (e) {
                case '\r': // Enter
                    term.write('\r\n');
                    if (currentLine.trim()) {
                        commandHistory.push(currentLine);
                        historyIndex = commandHistory.length;

                        if (!handleSpecialCommands(currentLine)) {
                            ws.send(JSON.stringify({
                                type: 'input',
                                terminalId: terminalId,
                                data: currentLine
                            }));
                        }
                    }
                    currentLine = '';
                    break;

                case '\u007F': // Backspace
                    if (currentLine.length > 0) {
                        currentLine = currentLine.slice(0, -1);
                        term.write('\b \b');
                    }
                    break;

                case '\u001b[A': // Flèche haut
                    if (historyIndex > 0) {
                        historyIndex--;
                        term.write('\r' + ' '.repeat(currentLine.length + 2) + '\r> ');
                        currentLine = commandHistory[historyIndex];
                        term.write(currentLine);
                    } else if (outputHistory.length > 0) {
                        // Afficher la sortie précédente
                        term.write('\r\n' + outputHistory.join('\r\n') + '\r\n');
                    }
                    break;

                case '\u001b[B': // Flèche bas
                    if (historyIndex < commandHistory.length) {
                        historyIndex++;
                        // Effacer la ligne actuelle
                        term.write('\r' + ' '.repeat(currentLine.length + 2) + '\r> ');
                        currentLine = historyIndex < commandHistory.length ?
                            commandHistory[historyIndex] : '';
                        term.write(currentLine);
                    }
                    break;

                default:
                    if (e >= String.fromCharCode(32) || e === '\t') {
                        currentLine += e;
                        term.write(e);
                    }
            }
        });

        // Démarrer la connexion
        connect();
    </script>
</body>

</html>