<!DOCTYPE html>
<html>
<head>
    <title>Terminal Simple</title>
    <link rel="stylesheet" href="/xterm/css/xterm.css" />
    <style>
        #terminal {
            width: 100%;
            height: 100vh;
            background: #000;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    
    <script src="/xterm/lib/xterm.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            cols: 80,
            rows: 24
        });

        const terminal = document.getElementById('terminal');
        term.open(terminal);

        // Connexion WebSocket
        const ws = new WebSocket(`ws://${window.location.host}`);
        let currentPath = '';
        let currentLine = '';
        let terminalId = null;

        ws.onopen = () => {
            term.write('Connexion au terminal...\r\n');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            
            if (message.type === 'terminal-id') {
                terminalId = message.id;
            } else if (message.type === 'output') {
                // Gestion du chemin courant
                const pathMatch = message.data.match(/^([A-Z]:\\[^\r\n>]+)>/i);
                if (pathMatch) {
                    currentPath = pathMatch[1];
                }
                term.write(message.data);
            }
        };

        // Gérer les entrées utilisateur
        term.onData(e => {
            const char = e;
            
            switch (char) {
                case '\r': // Enter
                    if (currentLine.trim()) {
                        term.write('\r\n');
                        ws.send(JSON.stringify({
                            type: 'input',
                            terminalId: terminalId,
                            data: currentLine + '\r\n'
                        }));
                        currentLine = '';
                    }
                    break;
                case '\u007F': // Backspace
                    if (currentLine.length > 0) {
                        currentLine = currentLine.slice(0, -1);
                        term.write('\b \b');
                    }
                    break;
                case '\u0003': // Ctrl+C
                    term.write('^C\r\n');
                    term.write(currentPath + '> ');
                    currentLine = '';
                    break;
                default:
                    if (char >= String.fromCharCode(32)) {
                        currentLine += char;
                        term.write(char);
                    }
            }
        });

        // Gestion des erreurs
        ws.onerror = () => {
            term.write('\r\nErreur de connexion\r\n');
        };

        ws.onclose = () => {
            term.write('\r\nConnection terminée\r\n');
        };
    </script>
</body>
</html>